<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Book Labour - AgriConnect</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
    <script type="importmap">
    {
        "imports": {
            "@google/generative-ai": "https://esm.sh/@google/generative-ai"
        }
    }
    </script>

    <style>
        /* Rich CSS Styles from your Index Page */
        :root {
            --primary-color: #2ECC71; --primary-hover: #27ae60; --secondary-color: #16A085;
            --heading-color: #2c3e50; --text-color: #34495e; --light-text: #7f8c8d;
            --bg-color: #ffffff; --alt-bg-color: #f4f7f6; --border-color: #e0e0e0;
            --white-color: #ffffff; --danger-color: #e74c3c; --warning-color: #f39c12;
            --primary-gradient: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            --card-shadow: 0 4px 12px rgba(0, 0, 0, 0.06);
            --card-shadow-hover: 0 10px 30px rgba(46, 204, 113, 0.15);
            --font-family: 'Inter', sans-serif; --transition-speed: 0.3s; --border-radius: 12px;
        }
        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
        html { scroll-behavior: smooth; }
        body { font-family: var(--font-family); color: var(--text-color); background-color: var(--alt-bg-color); line-height: 1.7; }
        .container { max-width: 900px; margin: 0 auto; padding: 0 20px; }
        .app-section { padding: 80px 0; }
        .app-header { background-color: rgba(255, 255, 255, 0.8); backdrop-filter: blur(10px); padding: 1rem 0; border-bottom: 1px solid #e0e0e0; position: sticky; top: 0; z-index: 1000; }
        .app-header .container, .logo, .main-nav { display: flex; align-items: center; }
        .app-header .container { justify-content: space-between; }
        .logo { gap: 12px; text-decoration: none; }
        .logo h1 { font-size: 1.6rem; color: var(--heading-color); }
        .main-nav { gap: 2rem; }
        .main-nav a { text-decoration: none; color: var(--text-color); font-weight: 600; }
        .card { background: var(--bg-color); border-radius: var(--border-radius); box-shadow: var(--card-shadow); }
        .btn { display: inline-flex; justify-content: center; align-items: center; gap: 0.5rem; padding: 12px 28px; border-radius: 50px; font-size: 0.95rem; font-weight: 600; cursor: pointer; text-decoration: none; text-align: center; transition: all var(--transition-speed) ease; }
        .btn-primary { background-image: var(--primary-gradient); color: var(--white-color); border: none; }
        .btn-primary:hover { transform: translateY(-4px); box-shadow: 0 8px 15px rgba(46, 204, 113, 0.3); }
        .btn-secondary { background-color: transparent; color: var(--text-color); border: 2px solid var(--border-color); }
        .btn-secondary:hover { background-color: var(--alt-bg-color); }
        .section-header { text-align: center; margin-bottom: 3rem; }
        .section-header h3 { font-size: 2.8rem; color: var(--heading-color); }
        .section-header p { font-size: 1.15rem; color: var(--light-text); max-width: 700px; margin: auto; }
        
        /* Booking Page Specific Styles */
        .profile-card { padding: 2rem; }
        .profile-header { display: flex; flex-direction: column; align-items: center; text-align: center; border-bottom: 1px solid var(--border-color); padding-bottom: 2rem; margin-bottom: 2rem; }
        .profile-photo { width: 150px; height: 150px; border-radius: 50%; object-fit: cover; border: 5px solid var(--primary-color); box-shadow: 0 5px 15px rgba(0,0,0,0.1); margin-bottom: 1rem; }
        .profile-header h2 { font-size: 2.5rem; color: var(--heading-color); margin: 0.5rem 0; }
        .profile-skills { color: var(--light-text); font-weight: 500; }
        .star-rating { color: var(--warning-color); font-size: 1.2rem; margin-top: 0.5rem; }
        .profile-tabs { display: flex; justify-content: center; gap: 0.5rem; margin-bottom: 2rem; }
        .tab-link { padding: 0.75rem 1.5rem; font-weight: 600; background: var(--alt-bg-color); border: none; border-radius: 50px; cursor: pointer; transition: all 0.3s; }
        .tab-link.active { background-image: var(--primary-gradient); color: white; box-shadow: 0 5px 15px rgba(46, 204, 113, 0.3); }
        .tab-content { display: none; animation: fadeIn 0.5s; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* Calendar Styles */
        .calendar-container { text-align: center; }
        .calendar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; }
        .calendar-header h4 { font-size: 1.5rem; color: var(--heading-color); margin: 0; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 0.5rem; }
        .calendar-day-name { font-weight: 600; color: var(--light-text); font-size: 0.9rem; }
        .calendar-day { display: flex; align-items: center; justify-content: center; height: 50px; border-radius: 50%; cursor: pointer; transition: all 0.2s; }
        .calendar-day.available:hover { background-color: #e8f5e9; }
        .calendar-day.selected { background-color: var(--primary-color); color: white; font-weight: 700; }
        .calendar-day.booked { background-color: var(--border-color); color: var(--light-text); cursor: not-allowed; text-decoration: line-through; }
        .calendar-day.empty { visibility: hidden; }

        /* Booking Summary & Actions */
        .booking-summary { margin-top: 2rem; padding: 1.5rem; background: var(--alt-bg-color); border-radius: var(--border-radius); text-align: center; }
        .booking-summary h4 { font-size: 1.2rem; margin-top: 0; }
        #total-cost { font-size: 2rem; font-weight: 800; color: var(--primary-color); }
        .main-actions { display: flex; justify-content: center; gap: 1rem; margin-top: 2rem; }
        
        /* Details & Reviews Tabs */
        .details-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem; text-align: center; }
        .detail-item { padding: 1rem; background: var(--alt-bg-color); border-radius: 8px; }
        .detail-item i { color: var(--primary-color); margin-bottom: 0.5rem; }
        .detail-item strong { display: block; font-size: 1.2rem; color: var(--heading-color); }
        .review-card { background: var(--alt-bg-color); padding: 1.5rem; border-radius: 8px; margin-bottom: 1rem; }
        .review-card p { margin: 0; font-style: italic; }
        .review-card .reviewer { text-align: right; font-weight: 600; margin-top: 0.5rem; color: var(--heading-color); }

        /* Modal Styles */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 1010; opacity: 0; pointer-events: none; transition: opacity 0.3s ease; }
        .modal-overlay.active { opacity: 1; pointer-events: auto; }
        .modal { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0.95); background: white; padding: 2rem; border-radius: var(--border-radius); z-index: 1011; width: 90%; max-width: 600px; opacity: 0; pointer-events: none; transition: all 0.3s ease; }
        .modal.active { transform: translate(-50%, -50%) scale(1); opacity: 1; pointer-events: auto; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; }
        .modal-header h4 { font-size: 1.5rem; color: var(--heading-color); margin:0; }
        .close-btn { font-size: 2rem; background: none; border: none; cursor: pointer; color: var(--light-text); line-height: 1; }
        #ai-message-box { background: var(--alt-bg-color); padding: 1.5rem; border-radius: 8px; margin-bottom: 1.5rem; white-space: pre-wrap; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid var(--primary-color); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 2rem auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    </style>
</head>
<body>
    <header class="app-header">
        <div class="container">
            <a href="index.html" class="logo">
                <svg width="32" height="32" viewBox="0 0 24 24"><path d="M21.58 9.55c-1.84-3.53-5.02-6.11-8.8-6.53-2.2-.25-4.44.2-6.39 1.28-1.95 1.08-3.51 2.76-4.48 4.79-.31.65-.21 1.41.24 1.95.45.54 1.2.75 1.86.54.66-.21 1.11-.82.9-1.48C4.7 9.1 5.97 7.74 7.56 6.9c1.59-.84 3.42-1.16 5.25-.9 3.03.43 5.61 2.5 6.96 5.11.39.75 1.22 1.13 2 .85s1.25-1.08.97-1.85zM2.42 14.45c1.84 3.53 5.02 6.11 8.8 6.53 2.2.25 4.44-.2 6.39-1.28 1.95-1.08 3.51-2.76 4.48-4.79.31-.65-.21 1.41-.24-1.95-.45-.54-1.2-.75-1.86-.54s-1.11.82-.9 1.48c-.79 1.67-2.06 3.03-3.65 3.87-1.59-.84-3.42-1.16-5.25-.9-3.03-.43-5.61-2.5-6.96-5.11-.39-.75-1.22-1.13-2-.85s-1.25 1.08-.97 1.85z" fill="#2ECC71"></path></svg>
                <h1>AgriConnect</h1>
            </a>
            <nav class="main-nav">
                <a href="index.html">Home</a>
                <a href="hire-labour.html" class="active">Hire Labour</a>
            </nav>
        </div>
    </header>

    <main>
        <div class="container app-section">
            <div class="section-header">
                <h3>Book Labourer</h3>
                <p>Select dates and confirm your booking with an AI-generated message.</p>
            </div>

            <div class="card profile-card" id="booking-details">
                <p style="text-align: center;">Loading labourer details...</p>
            </div>
        </div>
    </main>

    <div id="modal-overlay" class="modal-overlay"></div>
    <div id="ai-confirm-modal" class="modal">
        <div class="modal-header">
            <h4>Confirm Booking & Send Message</h4>
            <button class="close-btn" data-modal-close>&times;</button>
        </div>
        <div class="modal-body">
            <p>Your AI-generated confirmation message is ready. You can copy it and send it via WhatsApp.</p>
            <div id="ai-message-box">
                </div>
            <div id="modal-actions" style="display: flex; gap: 1rem;"></div>
        </div>
    </div>
    
    <script type="module">
        import { GoogleGenerativeAI } from "@google/generative-ai";

        document.addEventListener('DOMContentLoaded', () => {
            feather.replace();
            const API_KEY = "AIzaSyCeil1RRuySImAxPOO6bxh31VDRXms4JSc";
            const genAI = new GoogleGenerativeAI(API_KEY);

            const allLabourers = JSON.parse(localStorage.getItem('allLabourers')) || [
                { id: 1, name: "Ravi Kumar", contact: "919876543210", skills: "Ploughing, Seeding, Harvesting", price: "₹500/day", location: "Bannikuppe, Karnataka", rating: 4.5, bookedDates: ["2025-09-10", "2025-09-15"], photo: "https://placehold.co/150x150/E8F5E9/2c3e50?text=RK" },
                { id: 2, name: "Suresh Gowda", contact: "919988776655", skills: "Weeding, Pesticide Spraying", price: "₹450/day", location: "Hassan, Karnataka", rating: 4.8, bookedDates: ["2025-09-12", "2025-09-13"], photo: "https://placehold.co/150x150/E8F5E9/2c3e50?text=SG" },
            ];

            const bookingDetailsCard = document.getElementById('booking-details');
            const modal = document.getElementById('ai-confirm-modal');
            const modalOverlay = document.getElementById('modal-overlay');
            let selectedDates = [];
            
            function getLabourerFromURL() {
                const params = new URLSearchParams(window.location.search);
                const labourId = parseInt(params.get('id'));
                return allLabourers.find(l => l.id === labourId);
            }

            function renderProfile(labourer) {
                if (!labourer) {
                    bookingDetailsCard.innerHTML = "<p>Labourer not found.</p>";
                    return;
                }
                
                bookingDetailsCard.innerHTML = `
                    <div class="profile-header">
                        <img src="${labourer.photo}" alt="${labourer.name}" class="profile-photo">
                        <h2>${labourer.name}</h2>
                        <p class="profile-skills">${labourer.skills}</p>
                        <div class="star-rating">${'★'.repeat(Math.round(labourer.rating))}${'☆'.repeat(5 - Math.round(labourer.rating))} (${labourer.rating})</div>
                    </div>

                    <div class="profile-tabs">
                        <button class="tab-link active" data-tab="details">Details</button>
                        <button class="tab-link" data-tab="calendar">Booking Calendar</button>
                        <button class="tab-link" data-tab="reviews">Reviews</button>
                    </div>

                    <div id="details" class="tab-content active">
                        <div class="details-grid">
                            <div class="detail-item"><i data-feather="map-pin"></i><p>Location</p><strong>${labourer.location}</strong></div>
                            <div class="detail-item"><i data-feather="phone"></i><p>Contact</p><strong>${labourer.contact}</strong></div>
                            <div class="detail-item"><i data-feather="tag"></i><p>Price</p><strong>${labourer.price}</strong></div>
                        </div>
                    </div>
                    <div id="calendar" class="tab-content">
                        <div class="calendar-container">
                            <div class="calendar-header">
                                <button id="prev-month" disabled>&lt;</button>
                                <h4 id="month-year">September 2025</h4>
                                <button id="next-month" disabled>&gt;</button>
                            </div>
                            <div id="calendar-grid" class="calendar-grid"></div>
                        </div>
                        <div id="booking-summary" class="booking-summary">
                            <h4>Select dates on the calendar to see the total cost.</h4>
                        </div>
                    </div>
                    <div id="reviews" class="tab-content">
                        <div class="review-card"><p>"Ravi was very hardworking and professional. Finished the harvesting on time."</p><p class="reviewer">- Anil, Bannikuppe</p></div>
                        <div class="review-card"><p>"Excellent skills with the new seeder. Highly recommended."</p><p class="reviewer">- Sunita, Mandya</p></div>
                    </div>

                    <div class="main-actions">
                        <a href="https://wa.me/${labourer.contact}" target="_blank" class="btn btn-secondary">Call on WhatsApp</a>
                        <button id="confirm-booking-btn" class="btn btn-primary">Confirm Booking</button>
                    </div>
                `;
                feather.replace();
                renderCalendar(labourer.bookedDates);
                bindTabEvents();
                bindCalendarEvents();
                bindConfirmButton(labourer);
            }

            function renderCalendar(bookedDates) {
                const calendarGrid = document.getElementById('calendar-grid');
                calendarGrid.innerHTML = '<div>Sun</div><div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div>'.split('').map(d => `<div class="calendar-day-name">${d}</div>`).join('');
                
                const today = new Date('2025-09-01'); // For consistent demo
                const firstDayOfMonth = today.getDay();
                const daysInMonth = 30;

                for (let i = 0; i < firstDayOfMonth; i++) calendarGrid.innerHTML += `<div class="calendar-day empty"></div>`;
                
                for (let day = 1; day <= daysInMonth; day++) {
                    const dateStr = `2025-09-${String(day).padStart(2, '0')}`;
                    let classes = 'calendar-day';
                    if (bookedDates.includes(dateStr)) {
                        classes += ' booked';
                    } else {
                        classes += ' available';
                    }
                    calendarGrid.innerHTML += `<div class="${classes}" data-date="${dateStr}">${day}</div>`;
                }
            }
            
            function updateBookingSummary(labourer) {
                const summaryDiv = document.getElementById('booking-summary');
                const dailyRate = parseInt(labourer.price.match(/\d+/)[0]);
                if (selectedDates.length === 0) {
                    summaryDiv.innerHTML = '<h4>Select dates on the calendar to see the total cost.</h4>';
                } else {
                    const totalCost = selectedDates.length * dailyRate;
                    summaryDiv.innerHTML = `
                        <h4>Booking Summary</h4>
                        <p>${selectedDates.length} day${selectedDates.length > 1 ? 's' : ''} selected</p>
                        <div id="total-cost">₹${totalCost.toLocaleString('en-IN')}</div>
                        <p>${selectedDates.length} days × ${labourer.price}</p>
                    `;
                }
            }

            function bindTabEvents() {
                const tabs = document.querySelectorAll('.tab-link');
                const contents = document.querySelectorAll('.tab-content');
                tabs.forEach(tab => {
                    tab.addEventListener('click', () => {
                        tabs.forEach(t => t.classList.remove('active'));
                        tab.classList.add('active');
                        contents.forEach(c => c.classList.remove('active'));
                        document.getElementById(tab.dataset.tab).classList.add('active');
                    });
                });
            }

            function bindCalendarEvents() {
                const labourer = getLabourerFromURL();
                document.getElementById('calendar-grid').addEventListener('click', e => {
                    if (e.target.classList.contains('available')) {
                        const date = e.target.dataset.date;
                        e.target.classList.toggle('selected');
                        if (selectedDates.includes(date)) {
                            selectedDates = selectedDates.filter(d => d !== date);
                        } else {
                            selectedDates.push(date);
                        }
                        selectedDates.sort();
                        updateBookingSummary(labourer);
                    }
                });
            }

            function bindConfirmButton(labourer) {
                document.getElementById('confirm-booking-btn').addEventListener('click', async () => {
                    if (selectedDates.length === 0) {
                        alert("Please select at least one date from the calendar to book.");
                        return;
                    }
                    
                    const aiMessageBox = document.getElementById('ai-message-box');
                    const modalActions = document.getElementById('modal-actions');
                    modal.classList.add('active');
                    modalOverlay.classList.add('active');
                    aiMessageBox.innerHTML = `<div class="loader"></div>`;
                    modalActions.innerHTML = '';
                    
                    const dailyRate = parseInt(labourer.price.match(/\d+/)[0]);
                    const totalCost = selectedDates.length * dailyRate;
                    const prompt = `You are a helpful assistant for a farmer. The farmer wants to book a labourer named ${labourer.name} for the following dates: ${selectedDates.join(', ')}. The total cost is ₹${totalCost}. Generate a polite and clear confirmation message in Hinglish (Hindi written in English script) that the farmer can send to the labourer on WhatsApp. The message should confirm the dates, the work (general farm work), and the total agreed price.`;

                    try {
                        const model = genAI.getGenerativeModel({ model: "gemini-pro" });
                        const result = await model.generateContent(prompt);
                        const response = await result.response;
                        const messageText = response.text();
                        
                        aiMessageBox.textContent = messageText;
                        modalActions.innerHTML = `
                            <button id="copy-btn" class="btn btn-secondary">Copy Message</button>
                            <a href="https://wa.me/${labourer.contact}?text=${encodeURIComponent(messageText)}" target="_blank" class="btn btn-primary">Open WhatsApp</a>
                        `;
                        document.getElementById('copy-btn').addEventListener('click', () => {
                            navigator.clipboard.writeText(messageText);
                            alert('Message copied to clipboard!');
                        });

                    } catch(err) {
                        aiMessageBox.textContent = "Could not generate AI message. Please contact the labourer directly.";
                        console.error(err);
                    }
                });

                modal.querySelector('.close-btn').addEventListener('click', () => {
                    modal.classList.remove('active');
                    modalOverlay.classList.remove('active');
                });
            }

            // --- INITIALIZATION ---
            const labourer = getLabourerFromURL();
            renderProfile(labourer);
        });
    </script>
</body>
</html>