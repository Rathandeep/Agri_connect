<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hire Labour - AgriConnect</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>

    <style>
        /* Rich CSS Styles from your Index Page */
        :root {
            --primary-color: #2ECC71; --primary-hover: #27ae60; --secondary-color: #16A085;
            --heading-color: #2c3e50; --text-color: #34495e; --light-text: #7f8c8d;
            --bg-color: #ffffff; --alt-bg-color: #f4f7f6; --border-color: #e0e0e0;
            --white-color: #ffffff; --danger-color: #e74c3c;
            --primary-gradient: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            --card-shadow: 0 4px 12px rgba(0, 0, 0, 0.06);
            --card-shadow-hover: 0 10px 30px rgba(46, 204, 113, 0.15);
            --font-family: 'Inter', sans-serif; --transition-speed: 0.3s; --border-radius: 12px;
        }
        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
        html { scroll-behavior: smooth; }
        body { font-family: var(--font-family); color: var(--text-color); background-color: var(--alt-bg-color); line-height: 1.7; }
        .container { max-width: 1200px; margin: 0 auto; padding: 0 20px; }
        .app-section { padding: 80px 0; }
        .app-header { background-color: rgba(255, 255, 255, 0.8); backdrop-filter: blur(10px); padding: 1rem 0; border-bottom: 1px solid #e0e0e0; position: sticky; top: 0; z-index: 1000; }
        .app-header .container, .logo, .main-nav { display: flex; align-items: center; }
        .app-header .container { justify-content: space-between; }
        .logo { gap: 12px; text-decoration: none; }
        .logo h1 { font-size: 1.6rem; color: var(--heading-color); }
        .main-nav { gap: 2rem; }
        .main-nav a { text-decoration: none; color: var(--text-color); font-weight: 600; }
        .card { background: var(--bg-color); border-radius: var(--border-radius); padding: 2rem; box-shadow: var(--card-shadow); }
        .btn { display: inline-flex; justify-content: center; align-items: center; gap: 0.5rem; padding: 12px 28px; border-radius: 50px; font-size: 0.95rem; font-weight: 600; cursor: pointer; text-decoration: none; text-align: center; transition: all var(--transition-speed) ease; }
        .btn-primary { background-image: var(--primary-gradient); color: var(--white-color); border: none; }
        .btn-primary:hover { transform: translateY(-4px); box-shadow: 0 8px 15px rgba(46, 204, 113, 0.3); }
        .btn-secondary { background-color: transparent; color: var(--text-color); border: 2px solid var(--border-color); }
        .btn-secondary:hover { background-color: var(--alt-bg-color); }
        .form-group { margin-bottom: 1.5rem; }
        .form-group label { display: block; margin-bottom: 0.5rem; font-weight: 500; }
        .form-group input, .form-group textarea, .form-group select { width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; font-size: 1rem; }
        .form-group input:focus, .form-group textarea:focus, .form-group select:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(46, 204, 113, 0.2); }
        .section-header { text-align: center; margin-bottom: 3rem; }
        .section-header h3 { font-size: 2.8rem; color: var(--heading-color); }
        .section-header p { font-size: 1.15rem; color: var(--light-text); max-width: 700px; margin: auto; }
        .two-column-layout { display: grid; grid-template-columns: 1fr 1fr; gap: 2.5rem; align-items: flex-start; }
        .labour-list h3, .registration-form h3 { font-size: 1.8rem; color: var(--heading-color); margin-top: 0; margin-bottom: 2rem; }
        #labour-cards-container { display: grid; grid-template-columns: 1fr; gap: 1.5rem; }
        .labour-card { display: flex; align-items: center; gap: 1.5rem; padding: 1.5rem; background: var(--bg-color); border-radius: var(--border-radius); box-shadow: var(--card-shadow); transition: all var(--transition-speed); position: relative; }
        .labour-card:hover { transform: translateY(-5px); box-shadow: var(--card-shadow-hover); }
        .labour-photo { width: 80px; height: 80px; border-radius: 50%; object-fit: cover; flex-shrink: 0; border: 3px solid var(--primary-color); }
        .labour-details { text-align: left; flex-grow: 1; }
        .labour-card h4 { margin: 0 0 0.5rem 0; font-size: 1.4rem; color: var(--heading-color); }
        .labour-card p { margin: 0.25rem 0; }
        .labour-card .price { font-weight: bold; color: var(--primary-color); font-size: 1.1rem; }
        .labour-card .contact-btn { margin-top: 1rem; }
        .find-location-card { text-align: center; background: linear-gradient(135deg, #e0f2f1, #e8f5e9); margin-bottom: 1.5rem; }
        .registration-form .form-group { position: relative; }
        .voice-icon { position: absolute; right: 15px; top: 42px; cursor: pointer; color: var(--light-text); transition: color 0.3s; }
        .voice-icon:hover { color: var(--primary-color); }
        .camera-section { margin-top: 1.5rem; padding: 1.5rem; border: 1px solid var(--border-color); border-radius: var(--border-radius); text-align: center; }
        #camera-feed, #captured-photo-preview { width: 100%; max-width: 300px; height: auto; border-radius: 8px; margin-top: 1rem; display: none; }
        #camera-controls { display: flex; gap: 1rem; justify-content: center; margin-top: 1rem; }
        
        /* --- NEW STYLES --- */
        .labour-checkbox {
            cursor: pointer;
            width: 20px;
            height: 20px;
            accent-color: var(--primary-color);
        }
        .delete-btn {
            position: absolute;
            top: 12px;
            right: 12px;
            background: none;
            border: none;
            cursor: pointer;
            color: var(--light-text);
            padding: 5px;
        }
        .delete-btn:hover {
            color: var(--danger-color);
            transform: scale(1.1);
        }
        #mass-hire-controls {
            display: none; /* Initially hidden */
            padding: 1rem;
            background-color: var(--bg-color);
            border-radius: var(--border-radius);
            box-shadow: var(--card-shadow);
            margin-bottom: 1.5rem;
            text-align: center;
        }

        @media (max-width: 900px) { .two-column-layout { grid-template-columns: 1fr; } }
    </style>
</head>
<body>

    <header class="app-header">
        <div class="container">
            <a href="index.html" class="logo">
                <svg width="32" height="32" viewBox="0 0 24 24"><path d="M21.58 9.55c-1.84-3.53-5.02-6.11-8.8-6.53-2.2-.25-4.44.2-6.39 1.28-1.95 1.08-3.51 2.76-4.48 4.79-.31.65-.21 1.41.24 1.95.45.54 1.2.75 1.86.54.66-.21 1.11-.82.9-1.48C4.7 9.1 5.97 7.74 7.56 6.9c1.59-.84 3.42-1.16 5.25-.9 3.03.43 5.61 2.5 6.96 5.11.39.75 1.22 1.13 2 .85s1.25-1.08.97-1.85zM2.42 14.45c1.84 3.53 5.02 6.11 8.8 6.53 2.2.25 4.44-.2 6.39-1.28 1.95-1.08 3.51-2.76 4.48-4.79.31-.65.21-1.41-.24-1.95-.45-.54-1.2-.75-1.86-.54s-1.11.82-.9 1.48c-.79 1.67-2.06 3.03-3.65 3.87-1.59-.84-3.42-1.16-5.25-.9-3.03-.43-5.61-2.5-6.96-5.11-.39-.75-1.22-1.13-2-.85s-1.25 1.08-.97 1.85z" fill="#2ECC71"></path></svg>
                <h1>AgriConnect</h1>
            </a>
            <nav class="main-nav">
                <a href="prices.html">Prices</a>
                <a href="buy.html">Buy</a>
                <a href="sell.html">Sell</a>
                <a href="shop.html">Shop</a>
                <a href="rent-tools.html" class="active">Rent-tools</a>
                <a href="hire-labour.html">Labour</a>
                <a href="cart.html">Cart (<span id="cart-count">0</span>)</a>
            </nav>
        </div>
    </header>

    <main>
        <div class="container app-section">
            <div class="section-header">
                <h3>Hire Agricultural Labour</h3>
                <p>Find skilled laborers near you for all your farming needs, or register to offer your services.</p>
            </div>

            <div class="two-column-layout">
                <div class="labour-list">
                    <h3>Available Labourers</h3>
                    <div class="card find-location-card">
                        <h4>Find Labourers Near Me</h4>
                        <p id="location-info">Click the button below to allow location access.</p>
                        <button id="find-location-btn" class="btn btn-primary">Find Near Me</button>
                    </div>

                    <div id="mass-hire-controls">
                        <button id="contact-selected-btn" class="btn btn-primary">
                            Contact Selected (<span id="selected-count">0</span>)
                        </button>
                    </div>

                    <div id="labour-cards-container">
                        <p id="loading-message">Click "Find Near Me" to see available workers.</p>
                    </div>
                </div>

                <div class="registration-form card">
                    <h3>Register as a Labourer</h3>
                    <form id="registration-form">
                        <div class="form-group"><label for="name">Name*</label><input type="text" id="name" required><i class="voice-icon" data-feather="mic" data-target="name"></i></div>
                        <div class="form-group"><label for="contact">Contact Number*</label><input type="tel" id="contact" pattern="[0-9]{10}" placeholder="10-digit mobile number" required><i class="voice-icon" data-feather="mic" data-target="contact"></i></div>
                        <div class="form-group"><label for="location-reg">Location* (City, State)</label><input type="text" id="location-reg" placeholder="e.g., Mandya, Karnataka" required><i class="voice-icon" data-feather="mic" data-target="location-reg"></i></div>
                        <button type="button" id="get-live-location-btn" class="btn btn-secondary" style="width: 100%; margin-bottom: 1.5rem;">Get My Live Location</button>
                        <div class="form-group"><label for="skills">Skills* (e.g., Ploughing, Seeding)</label><textarea id="skills" rows="3" required></textarea><i class="voice-icon" data-feather="mic" data-target="skills"></i></div>
                        <div class="form-group"><label for="price">Price* (e.g., ₹500/day)</label><input type="text" id="price" required><i class="voice-icon" data-feather="mic" data-target="price"></i></div>
                        <div class="camera-section">
                            <h4>Your Live Photo</h4>
                            <video id="camera-feed" autoplay></video>
                            <img id="captured-photo-preview" src="#" alt="Captured Photo">
                            <div id="camera-controls">
                                <button type="button" id="start-camera-btn" class="btn btn-secondary">Start Camera</button>
                                <button type="button" id="capture-photo-btn" class="btn btn-primary" style="display:none;">Capture Photo</button>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary" style="width: 100%; margin-top: 1rem;">Register</button>
                    </form>
                </div>
            </div>
        </div>
    </main>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            feather.replace();

            // --- DATA MANAGEMENT ---
            let allLabourers = JSON.parse(localStorage.getItem('allLabourers')) || [
                { id: 1, name: "Ravi Kumar", contact: "9876543210", skills: "Ploughing, Seeding, Harvesting", price: "₹500/day", location: "Bannikuppe, Karnataka", photo: "https://placehold.co/80x80/E8F5E9/2c3e50?text=RK" },
                { id: 2, name: "Suresh Gowda", contact: "9988776655", skills: "Weeding, Pesticide Spraying", price: "₹450/day", location: "Hassan, Karnataka", photo: "https://placehold.co/80x80/E8F5E9/2c3e50?text=SG" },
                { id: 3, name: "Priya Sharma", contact: "9001122334", skills: "Organic Farming, Crop Management", price: "₹600/day", location: "Bengaluru, Karnataka", photo: "https://placehold.co/80x80/E8F5E9/2c3e50?text=PS" },
                { id: 4, name: "Arjun Singh", contact: "9123456789", skills: "Tractor Operation, Soil Testing", price: "₹800/day", location: "Mysuru, Karnataka", photo: "https://placehold.co/80x80/E8F5E9/2c3e50?text=AS" },
                { id: 5, name: "Lakshmi Devi", contact: "9234567890", skills: "Harvesting, Sorting, Packing", price: "₹400/day", location: "Bannikuppe, Karnataka", photo: "https://placehold.co/80x80/E8F5E9/2c3e50?text=LD" },
            ];
            
            if (!localStorage.getItem('allLabourers')) {
                localStorage.setItem('allLabourers', JSON.stringify(allLabourers));
            }
            
            // --- DOM ELEMENTS ---
            const locationInfo = document.getElementById('location-info');
            const findLocationBtn = document.getElementById('find-location-btn');
            const labourContainer = document.getElementById('labour-cards-container');
            const registrationForm = document.getElementById('registration-form');
            const getLiveLocationBtn = document.getElementById('get-live-location-btn');
            const locationRegInput = document.getElementById('location-reg');
            const cameraFeed = document.getElementById('camera-feed');
            const startCameraBtn = document.getElementById('start-camera-btn');
            const capturePhotoBtn = document.getElementById('capture-photo-btn');
            const photoCanvas = document.createElement('canvas');
            const capturedPhotoPreview = document.getElementById('captured-photo-preview');
            const massHireControls = document.getElementById('mass-hire-controls');
            const contactSelectedBtn = document.getElementById('contact-selected-btn');
            const selectedCountSpan = document.getElementById('selected-count');

            // --- CORE FUNCTIONS ---

            function displayLabourers(labourers) {
                labourContainer.innerHTML = '';
                if (labourers.length === 0) {
                    labourContainer.innerHTML = `<p class="card">No labourers found for the selected location.</p>`;
                    return;
                }
                labourers.forEach(labour => {
                    // New members will have a large timestamp as ID, demo data has small numbers
                    const isDeletable = typeof labour.id === 'number' && labour.id > 1000;
                    const whatsappMessage = encodeURIComponent("Hello, I found your profile on AgriConnect and I am interested in hiring you.");
                    
                    labourContainer.innerHTML += `
                        <div class="labour-card">
                            <input type="checkbox" class="labour-checkbox" data-contact="${labour.contact}">
                            <img src="${labour.photo}" alt="${labour.name}" class="labour-photo">
                            <div class="labour-details">
                                <h4>${labour.name}</h4>
                                <p><strong>Skills:</strong> ${labour.skills}</p>
                                <p><strong>Location:</strong> ${labour.location}</p>
                                <p class="price">${labour.price}</p>
                                <a href="https://wa.me/91${labour.contact}?text=${whatsappMessage}" target="_blank" class="btn btn-primary contact-btn">Contact on WhatsApp</a>
                            </div>
                            ${isDeletable ? `<button class="delete-btn" data-id="${labour.id}" title="Delete Registration"><i data-feather="trash-2"></i></button>` : ''}
                        </div>`;
                });
                feather.replace(); // To render new icons like the trash icon
                attachCardListeners();
                updateMassHireUI();
            }
            
            function attachCardListeners() {
                // Attach listeners for delete buttons
                document.querySelectorAll('.delete-btn').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const labourId = e.currentTarget.dataset.id;
                        if (confirm('Are you sure you want to delete this registration?')) {
                            deleteLabourer(parseInt(labourId));
                        }
                    });
                });

                // Attach listeners for checkboxes
                document.querySelectorAll('.labour-checkbox').forEach(checkbox => {
                    checkbox.addEventListener('change', updateMassHireUI);
                });
            }
            
            function deleteLabourer(id) {
                allLabourers = allLabourers.filter(l => l.id !== id);
                localStorage.setItem('allLabourers', JSON.stringify(allLabourers));
                displayLabourers(allLabourers);
            }
            
            function updateMassHireUI() {
                const selectedCheckboxes = document.querySelectorAll('.labour-checkbox:checked');
                const count = selectedCheckboxes.length;
                
                if (count > 0) {
                    selectedCountSpan.textContent = count;
                    massHireControls.style.display = 'block';
                } else {
                    massHireControls.style.display = 'none';
                }
            }

            function updateCartCount() {
                // 1. Get the cart from localStorage, or an empty array if it doesn't exist.
                const cart = JSON.parse(localStorage.getItem('agriConnectCart')) || [];

                // 2. Calculate the total number of items by summing up the quantities of each item.
                const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
            
                // 3. Find the cart count element in the header.
                const cartCountElement = document.getElementById('cart-count');
            
                // 4. Update the text if the element is found.
                if (cartCountElement) {
                    cartCountElement.textContent = totalItems;
                }
            }

            // Call the function once when the page loads to set the initial count.
            updateCartCount();

            function getPlaceNameFromCoords(lat, lon) {
                // This is a simplified simulation. A real app would use a Geocoding API.
                if (lat > 12.2 && lat < 12.4 && lon > 76.5 && lon < 76.7) return "Mysuru, Karnataka";
                if (lat > 12.8 && lat < 13.1 && lon > 77.5 && lon < 77.7) return "Bengaluru, Karnataka";
                return "Nearby Area, Karnataka";
            }

            // --- EVENT LISTENERS ---

            findLocationBtn.addEventListener('click', () => {
                if ("geolocation" in navigator) {
                    locationInfo.textContent = "Fetching your location...";
                    labourContainer.innerHTML = `<p>Finding labourers near you...</p>`;
                    navigator.geolocation.getCurrentPosition(
                        position => {
                            const locationName = getPlaceNameFromCoords(position.coords.latitude, position.coords.longitude);
                            locationInfo.innerHTML = `Showing results near <strong>${locationName}</strong>`;
                            const nearbyLabourers = allLabourers.filter(l => l.location.includes(locationName.split(',')[0]));
                            displayLabourers(nearbyLabourers.length > 0 ? nearbyLabourers : allLabourers);
                        },
                        () => {
                            locationInfo.textContent = "Could not get location. Showing all labourers.";
                            displayLabourers(allLabourers);
                        }
                    );
                } else {
                    locationInfo.textContent = "Geolocation is not supported.";
                    displayLabourers(allLabourers);
                }
            });

            getLiveLocationBtn.addEventListener('click', () => {
                if ("geolocation" in navigator) {
                    locationRegInput.value = "Fetching live location...";
                    navigator.geolocation.getCurrentPosition(
                        position => { locationRegInput.value = getPlaceNameFromCoords(position.coords.latitude, position.coords.longitude); },
                        () => { locationRegInput.value = "Location not available."; }
                    );
                } else { locationRegInput.value = "Geolocation not supported."; }
            });

            registrationForm.addEventListener('submit', function(event) {
                event.preventDefault();
                const newLabour = {
                    id: Date.now(),
                    name: document.getElementById('name').value,
                    contact: document.getElementById('contact').value,
                    skills: document.getElementById('skills').value,
                    price: document.getElementById('price').value,
                    location: document.getElementById('location-reg').value,
                    photo: capturedPhotoPreview.src.startsWith('data:image') ? capturedPhotoPreview.src : `https://placehold.co/80x80/E8F5E9/2c3e50?text=${document.getElementById('name').value.substring(0,2)}`
                };
                allLabourers.unshift(newLabour); // Add to the top of the list
                localStorage.setItem('allLabourers', JSON.stringify(allLabourers));
                displayLabourers(allLabourers);
                this.reset();
                capturedPhotoPreview.style.display = 'none';
                capturedPhotoPreview.src = '#';
                alert("Registration successful!");
            });

            contactSelectedBtn.addEventListener('click', () => {
                const selectedCheckboxes = document.querySelectorAll('.labour-checkbox:checked');
                if (selectedCheckboxes.length === 0) {
                    alert("Please select at least one labourer to contact.");
                    return;
                }

                const message = encodeURIComponent("Hello, I found your profile on AgriConnect and I am interested in hiring your services.");
                
                selectedCheckboxes.forEach((checkbox, index) => {
                    const contact = checkbox.dataset.contact;
                    const url = `https://wa.me/91${contact}?text=${message}`;
                    
                    // Staggering the opening of tabs can sometimes help with popup blockers
                    setTimeout(() => {
                        window.open(url, '_blank');
                    }, index * 300);
                });
            });

            // --- VOICE & CAMERA WIZARDRY ---

            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (SpeechRecognition) {
                document.querySelectorAll('.voice-icon').forEach(icon => {
                    icon.addEventListener('click', () => {
                        const recognition = new SpeechRecognition();
                        recognition.lang = 'en-IN';
                        const targetInput = document.getElementById(icon.dataset.target);
                        recognition.onstart = () => { targetInput.placeholder = "Listening..."; };
                        recognition.onend = () => { targetInput.placeholder = ""; };
                        recognition.onresult = (event) => { targetInput.value = event.results[0][0].transcript; };
                        recognition.start();
                    });
                });
            }

            let stream;
            startCameraBtn.addEventListener('click', async () => {
                try {
                    stream = await navigator.mediaDevices.getUserMedia({ video: true });
                    cameraFeed.srcObject = stream;
                    cameraFeed.style.display = 'block';
                    capturePhotoBtn.style.display = 'inline-flex';
                    startCameraBtn.style.display = 'none';
                } catch (err) { alert("Camera access was denied."); }
            });

            capturePhotoBtn.addEventListener('click', () => {
                photoCanvas.width = cameraFeed.videoWidth;
                photoCanvas.height = cameraFeed.videoHeight;
                photoCanvas.getContext('2d').drawImage(cameraFeed, 0, 0);
                capturedPhotoPreview.src = photoCanvas.toDataURL('image/png');
                capturedPhotoPreview.style.display = 'block';
                stream.getTracks().forEach(track => track.stop());
                cameraFeed.style.display = 'none';
                capturePhotoBtn.style.display = 'none';
                startCameraBtn.style.display = 'inline-flex';
            });

            // --- INITIAL LOAD ---
            displayLabourers(allLabourers);

        });
    </script>
</body>
</html>