<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Fertilizer Recommender - AgriConnect</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>

    <script type="importmap">
    {
        "imports": {
            "@google/generative-ai": "https://esm.sh/@google/generative-ai"
        }
    }
    </script>
    <style>
        :root {
            --primary-color: #34c759;
            --primary-hover: #2db84d;
            --secondary-color: #007bff;
            --heading-color: #1a2a3a;
            --text-color: #4a4a4a;
            --light-text: #999;
            --bg-color: #ffffff;
            --alt-bg-color: #f7f9fb;
            --border-color: #e0e6ed;
            --white-color: #ffffff;
            --danger-color: #dc3545;
            --primary-gradient: linear-gradient(45deg, var(--primary-color), #2ed8b6);
            --card-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
            --font-family: 'Inter', sans-serif;
            --transition-speed: 0.4s;
            --border-radius: 16px;
        }
        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
        html { scroll-behavior: smooth; }
        body { font-family: var(--font-family); color: var(--text-color); background-color: var(--alt-bg-color); line-height: 1.8; }
        .container { max-width: 1200px; margin: 0 auto; padding: 0 20px; }
        .app-section { padding: 80px 0; }
        .section-header { text-align: center; margin-bottom: 3rem; }
        .section-header h3 { font-size: 2.8rem; color: var(--heading-color); }
        .section-header p { font-size: 1.2rem; color: var(--light-text); max-width: 600px; margin: 0 auto; }
        .app-header { background-color: rgba(255, 255, 255, 0.95); backdrop-filter: blur(15px); padding: 1.2rem 0; border-bottom: 1px solid var(--border-color); position: sticky; top: 0; z-index: 1000; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05); }
        .app-header .container, .logo, .main-nav { display: flex; align-items: center; }
        .app-header .container { justify-content: space-between; }
        .logo { gap: 10px; text-decoration: none; display: flex; align-items: center; }
        .logo svg { width: 32px; height: 32px; color: var(--primary-color); }
        .logo h1 { font-size: 1.8rem; color: var(--heading-color); font-weight: 800; }
        .main-nav { display: flex; justify-content: space-around; position: relative; gap: 2rem; }
        .main-nav a { text-decoration: none; color: var(--text-color); font-weight: 600; position: relative; padding: 10px; }
        .main-nav a.active::after { content: ""; position: absolute; bottom: 0; left: 0; width: 100%; height: 3px; background-color: var(--primary-color); transition: all 0.3s ease; }
        .card { background: var(--bg-color); border-radius: var(--border-radius); padding: 2.5rem; box-shadow: var(--card-shadow); border: 1px solid var(--border-color); }
        .btn { display: inline-block; padding: 14px 32px; border-radius: 50px; border: none; font-size: 1rem; font-weight: 700; cursor: pointer; text-decoration: none; text-align: center; transition: all var(--transition-speed) ease; }
        .btn:disabled { background: #dcdcdc; color: #999; cursor: not-allowed; transform: none; box-shadow: none; }
        .btn-primary { background-image: var(--primary-gradient); color: var(--white-color); }
        .btn-primary:not(:disabled):hover { transform: translateY(-5px); box-shadow: 0 12px 25px rgba(52, 199, 89, 0.3); }
        .btn-secondary { background-color: transparent; color: var(--text-color); border: 2px solid var(--border-color); }
        .btn-secondary:hover { background-color: var(--alt-bg-color); }
        .planner-layout { display: grid; grid-template-columns: 1fr 2fr; gap: 2.5rem; align-items: flex-start; }
        .input-card h4 { font-size: 1.6rem; color: var(--heading-color); margin-bottom: 1.5rem; text-align: center; }
        .form-group { margin-bottom: 1.2rem; }
        .form-group label { display: block; font-weight: 600; margin-bottom: 0.6rem; font-size: 0.95rem; color: var(--heading-color); }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 14px; border: 1px solid var(--border-color); border-radius: 10px; font-family: inherit; font-size: 1rem; transition: border-color var(--transition-speed), box-shadow var(--transition-speed); }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 4px rgba(52, 199, 89, 0.1); }

        .plan-placeholder { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; text-align: center; color: var(--light-text); }
        .plan-placeholder .icon { color: var(--primary-color); margin-bottom: 1rem; }
        .loader-container { display: none; flex-direction: column; align-items: center; justify-content: center; height: 100%; gap: 1rem; font-weight: 600; color: var(--heading-color); }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid var(--primary-color); border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .plan-content h4 { font-size: 1.6rem; margin-bottom: 1rem; color: var(--heading-color); }
        .plan-content h5 { font-size: 1.3rem; margin-top: 2rem; margin-bottom: 0.8rem; color: var(--secondary-color); }
        .plan-content ul { list-style-type: 'ðŸŒ± '; padding-left: 20px; }
        .plan-content li { margin-bottom: 0.8rem; }
        .plan-content p { white-space: pre-wrap; margin-bottom: 1.5rem; }
        
        /* New Styles for Shop Section */
        .shop-controls { display: flex; gap: 1rem; flex-wrap: wrap; justify-content: space-between; align-items: center; margin-bottom: 2rem; }
        .search-bar { position: relative; flex-grow: 1; }
        .search-bar input { width: 100%; padding: 0.75rem 1rem 0.75rem 2.5rem; border-radius: 50px; border: 1px solid var(--border-color); }
        .search-bar i { position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); color: var(--light-text); }
        #all-products-category-filter { padding: 0.75rem 1rem; border-radius: 8px; border: 1px solid var(--border-color); }

        .product-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 1.5rem; }
        .product-card { display: flex; flex-direction: column; text-align: center; padding: 1.5rem; transition: transform var(--transition-speed), box-shadow var(--transition-speed); }
        .product-card:hover { transform: translateY(-5px); box-shadow: 0 15px 40px rgba(0, 0, 0, 0.1); }
        .product-card-title { font-size: 1.1rem; font-weight: 600; color: var(--heading-color); flex-grow: 1; margin: 0.25rem 0; }
        .product-card-price { font-size: 1.3rem; font-weight: 700; color: var(--primary-color); margin: 0.5rem 0 1rem; }
        .buy-controls { display: flex; gap: 0.5rem; align-items: center; margin-top: auto; }
        .quantity-input { width: 60px; padding: 10px; border: 1px solid var(--border-color); border-radius: 50px; text-align: center; font-weight: 600; font-size: 1rem; }
        .buy-controls .btn { flex-grow: 1; padding: 10px; }

        @media (max-width: 900px) { .planner-layout { grid-template-columns: 1fr; } }
    </style>
</head>
<body>
    <header class="app-header">
        <div class="container">
            <a href="index.html" class="logo">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-leaf"><path d="M14.8 6.2a2.8 2.8 0 0 0-4.6 0L4.2 12.8a2.8 2.8 0 0 0 .6 3.8l5.2 5.2c1.2 1.2 3.1 1.2 4.3 0l5.2-5.2a2.8 2.8 0 0 0 .6-3.8z"></path><path d="M12 17.5a.5.5 0 0 1-.5-.5V6.5a.5.5 0 0 1 1 0v10.5a.5.5 0 0 1-.5.5z"></path></svg>
                <h1>AgriConnect</h1>
            </a>
            <nav class="main-nav">
                <a href="prices.html">Prices</a>
                <a href="buy.html">Buy</a>
                <a href="sell.html">Sell</a>
                <a href="shop.html" class="active">Shop</a>
                <a href="rent-tools.html">Rent-tools</a>
                <a href="hire-labour.html">Labour</a>
                <a href="cart.html">Cart (<span id="cart-count">0</span>)</a>
            </nav>
        </div>
    </header>

    <main>
        <section class="app-section">
            <div class="container">
                <div class="section-header">
                    <h3>AI Fertilizer Recommendation</h3>
                    <p>Get a personalized fertilizer plan for your crop by providing your soil's nutrient levels.</p>
                </div>

                <div class="planner-layout">
                    <div class="card input-card">
                        <h4>Your Soil & Crop Details</h4>
                        <div class="form-group">
                            <label for="crop-type">Crop Type*</label>
                            <input type="text" id="crop-type" placeholder="e.g., Rice, Wheat, Tomato" value="Rice" required>
                        </div>
                        <div class="form-group">
                            <label for="n-level">Soil Nitrogen (N)</label>
                            <input type="number" id="n-level" placeholder="e.g., 40" required value="40">
                        </div>
                        <div class="form-group">
                            <label for="p-level">Soil Phosphorus (P)</label>
                            <input type="number" id="p-level" placeholder="e.g., 20" required value="20">
                        </div>
                        <div class="form-group">
                            <label for="k-level">Soil Potassium (K)</label>
                            <input type="number" id="k-level" placeholder="e.g., 30" required value="30">
                        </div>
                        <div class="form-group">
                            <label for="ph-level">Soil pH</label>
                            <input type="number" id="ph-level" step="0.1" placeholder="e.g., 6.5" required value="6.5">
                        </div>
                        <div class="form-actions">
                            <button id="generate-plan-btn" class="btn btn-primary">Get Recommendation</button>
                        </div>
                    </div>

                    <div class="card plan-card">
                        <div id="plan-placeholder" class="plan-placeholder">
                            <i data-feather="droplet" class="icon" style="width: 60px; height: 60px;"></i>
                            <h4>Your Recommendation Report</h4>
                            <p>Fill out the form to get a personalized report with actionable advice and product suggestions.</p>
                        </div>
                        <div id="loader-container" class="loader-container">
                            <div class="loader"></div>
                            <p id="loader-message">Analyzing your soil data...</p>
                        </div>
                        <div id="plan-content" style="display: none;"></div>
                    </div>
                </div>
            </div>
        </section>

        <section class="app-section">
            <div class="container">
                <div class="section-header">
                    <h3>Browse All Products</h3>
                    <p>Find all the seeds, fertilizers, and tools you need for your farm.</p>
                </div>
                <div class="shop-controls">
                    <div class="search-bar">
                        <i data-feather="search"></i>
                        <input type="text" id="all-products-search" placeholder="Search all products...">
                    </div>
                    <select id="all-products-category-filter">
                        <option value="all">All Categories</option>
                        <option value="Seeds">Seeds</option>
                        <option value="Fertilizers">Fertilizers</option>
                        <option value="Pesticides">Pesticides</option>
                        <option value="Tools">Tools</option>
                    </select>
                </div>
                <div class="card">
                    <div id="all-products-grid" class="product-grid"></div>
                    <p id="no-all-products-message" class="card" style="text-align:center; display: none;">No products match your search.</p>
                </div>
            </div>
        </section>
    </main>

    <div id="toast-container"></div>
    
    <script type="module">
        import { GoogleGenerativeAI } from "@google/generative-ai";

        document.addEventListener('DOMContentLoaded', () => {
            feather.replace();
            const API_KEY = "AIzaSyCeil1RRuySImAxPOO6bxh31VDRXms4JSc";
            const genAI = new GoogleGenerativeAI(API_KEY);
            const model = genAI.getGenerativeModel({ model: "gemini-1.5-flash" });

            const app = {
                elements: {
                    form: document.getElementById('generate-plan-btn'),
                    cropInput: document.getElementById('crop-type'),
                    nLevel: document.getElementById('n-level'),
                    pLevel: document.getElementById('p-level'),
                    kLevel: document.getElementById('k-level'),
                    phLevel: document.getElementById('ph-level'),
                    planPlaceholder: document.getElementById('plan-placeholder'),
                    loader: document.getElementById('loader-container'),
                    loaderMessage: document.getElementById('loader-message'),
                    planContent: document.getElementById('plan-content'),
                    allProductsSearch: document.getElementById('all-products-search'),
                    allProductsCategoryFilter: document.getElementById('all-products-category-filter'),
                    allProductsGrid: document.getElementById('all-products-grid'),
                    noAllProductsMessage: document.getElementById('no-all-products-message'),
                    cartCount: document.getElementById('cart-count'),
                },
                state: {
                    availableProducts: [
                        { id: 's1', name: 'Kaveri Paddy Seeds (10kg)', price: 850, category: 'Seeds', keywords: ['paddy', 'rice', 'seed'] },
                        { id: 's2', name: 'Ankur Wheat Seeds (20kg)', price: 1200, category: 'Seeds', keywords: ['wheat', 'seed'] },
                        { id: 's3', name: 'JK Cotton Seeds (500g)', price: 950, category: 'Seeds', keywords: ['cotton', 'seed'] },
                        { id: 'f1', name: 'IFFCO Urea (45kg)', price: 266, category: 'Fertilizers', keywords: ['urea', 'nitrogen'] },
                        { id: 'f2', name: 'Tata DAP (50kg)', price: 1350, category: 'Fertilizers', keywords: ['dap', 'phosphate'] },
                        { id: 'f4', name: 'IFFCO NPK 19-19-19 (1kg)', price: 150, category: 'Fertilizers', keywords: ['npk 19-19-19', '19:19:19', 'balanced'] },
                        { id: 'f5', name: 'IFFCO Muriate of Potash (50kg)', price: 1700, category: 'Fertilizers', keywords: ['mop', 'potash', 'potassium'] },
                        { id: 'f6', name: 'Organic Manure (5kg)', price: 250, category: 'Fertilizers', keywords: ['organic', 'manure', 'compost'] },
                        { id: 'p1', name: 'Bayer Confidor (1L)', category: 'Pesticides', price: 2100, keywords: ['confidor', 'insecticide', 'pest'] },
                        { id: 't1', name: 'Neptune Manual Sprayer (16L)', category: 'Tools', price: 1500, keywords: ['sprayer', 'tool'] },
                    ]
                },

                init() {
                    this.bindEvents();
                    this.updateCartCount();
                    this.renderAllProducts();
                    const messages = ["Analyzing your soil data...", "Consulting agricultural databases...", "Crafting your personalized report..."];
                    let messageIndex = 0;
                    setInterval(() => {
                        if (this.elements.loader.style.display === 'flex') {
                            this.elements.loaderMessage.textContent = messages[messageIndex];
                            messageIndex = (messageIndex + 1) % messages.length;
                        }
                    }, 3000);
                },

                bindEvents() {
                    this.elements.form.addEventListener('click', this.getRecommendation.bind(this));
                    document.body.addEventListener('click', this.handleDynamicClicks.bind(this));
                    this.elements.allProductsSearch.addEventListener('input', () => this.renderAllProducts());
                    this.elements.allProductsCategoryFilter.addEventListener('change', () => this.renderAllProducts());
                },
                
                getCart: () => JSON.parse(localStorage.getItem('agriConnectCart')) || [],
                saveCart: (cart) => localStorage.setItem('agriConnectCart', JSON.stringify(cart)),
                
                updateCartCount() {
                    const totalItems = this.getCart().reduce((sum, item) => sum + item.quantity, 0);
                    this.elements.cartCount.textContent = totalItems;
                },

                showToast(message) {
                    const container = document.getElementById('toast-container') || document.createElement('div');
                    if (!container.id) { container.id = 'toast-container'; document.body.appendChild(container); }
                    const toast = document.createElement('div');
                    toast.className = 'toast';
                    toast.textContent = message;
                    container.appendChild(toast);
                    setTimeout(() => toast.remove(), 3000);
                },

                addToCart(productId, quantity = 1) {
                    if (quantity < 1 || !Number.isInteger(quantity)) return this.showToast("Please enter a valid quantity.");
                    let cart = this.getCart();
                    const product = this.state.availableProducts.find(p => p.id === productId);
                    if (!product) return;
                    const existingItem = cart.find(item => item.id === productId);
                    if (existingItem) { existingItem.quantity += quantity; }
                    else { cart.push({ id: product.id, name: product.name, price: product.price, imageUrl: null, quantity: quantity }); }
                    this.saveCart(cart);
                    this.updateCartCount();
                    this.showToast(`${quantity} x ${product.name} added to cart!`);
                },
                
                showView(viewToShow) {
                    const views = ['planPlaceholder', 'loader', 'planContent'];
                    views.forEach(view => {
                        this.elements[view].style.display = (view === viewToShow) ? (view === 'planContent' ? 'block' : 'flex') : 'none';
                    });
                },

                async getRecommendation(e) {
                    e.preventDefault();
                    const crop = this.elements.cropInput.value.trim();
                    const n = this.elements.nLevel.value.trim();
                    const p = this.elements.pLevel.value.trim();
                    const k = this.elements.kLevel.value.trim();
                    const ph = this.elements.phLevel.value.trim();
                    
                    if (!crop || !n || !p || !k || !ph) {
                        this.showToast("Please fill in all required fields.");
                        return;
                    }

                    this.showView('loader');

                    const prompt = `As an expert agricultural advisor, provide a personalized fertilizer recommendation for a farmer in India. The plan should be for:
- **Crop:** ${crop}
- **Soil Nitrogen (N):** ${n} kg/acre
- **Soil Phosphorus (P):** ${p} kg/acre
- **Soil Potassium (K):** ${k} kg/acre
- **Soil pH:** ${ph}

The response must be detailed, practical, and easy to understand. Structure the plan into distinct sections using Markdown headings (##). The sections should be:
1.  **Soil Analysis Summary:** A brief summary of the provided soil data.
2.  **Fertilizer Recommendation:** A clear recommendation for specific fertilizer types. Include the reasoning behind the choice.
3.  **Application Method & Timing:** Practical advice on how and when to apply the fertilizers.
4.  **Recommended Products:** A list of specific products from the following list that are suitable for this recommendation: IFFCO Urea (for Nitrogen), Tata DAP (for Phosphorus), IFFCO Muriate of Potash (for Potassium), IFFCO NPK 19-19-19 (for balanced NPK). For each product, specify which nutrient it provides.

Use Markdown for a clean format (e.g., ##, -, **).`;

                    try {
                        const result = await model.generateContent(prompt);
                        const response = await result.response;
                        const text = response.text();
                        this.displayPlan(text);
                    } catch (error) {
                        console.error("API Error:", error);
                        this.elements.planContent.innerHTML = `<p style="color:var(--danger-color);"><strong>Plan Generation Failed!</strong><br>Could not get a response from the AI. Please check your API key or try again later.</p>`;
                        this.showView('planContent');
                    }
                },

                displayPlan(markdownText) {
                    const htmlContent = this.markedParse(markdownText);
                    this.elements.planContent.innerHTML = htmlContent;
                    this.showView('planContent');
                    feather.replace();
                },

                markedParse(text) {
                    let html = text.replace(/^#+\s*(.*)$/gm, '<h4>$1</h4>');
                    html = html.replace(/^\*\s*(.*)$/gm, '<li>$1</li>');
                    html = html.replace(/^(<li>.*<\/li>)+/gm, '<ul>$&</ul>');
                    html = html.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
                    return html;
                },

                renderAllProducts() {
                    const grid = this.elements.allProductsGrid;
                    grid.innerHTML = '';
                    const searchTerm = this.elements.allProductsSearch.value.toLowerCase();
                    const category = this.elements.allProductsCategoryFilter.value;

                    let filteredProducts = this.state.availableProducts.filter(p => {
                        const matchesCategory = category === 'all' || p.category === category;
                        const matchesSearch = p.name.toLowerCase().includes(searchTerm) || p.keywords.some(k => k.includes(searchTerm));
                        return matchesCategory && matchesSearch;
                    });

                    this.elements.noAllProductsMessage.style.display = filteredProducts.length === 0 ? 'block' : 'none';

                    filteredProducts.forEach(p => {
                        grid.innerHTML += `
                            <div class="card product-card">
                                <h4 class="product-card-title">${p.name}</h4>
                                <div class="product-card-price">â‚¹${p.price.toLocaleString()}</div>
                                <div class="buy-controls">
                                    <input type="number" class="quantity-input" value="1" min="1" style="max-width: 60px;">
                                    <button class="btn btn-primary add-to-cart-btn" data-id="${p.id}">Add to Cart</button>
                                </div>
                            </div>`;
                    });
                    feather.replace();
                },

                handleDynamicClicks(e) {
                    const target = e.target.closest('button');
                    if (target && target.classList.contains('add-to-cart-btn')) {
                        const quantityInput = target.closest('.buy-controls, .product-rec-card').querySelector('.quantity-input');
                        const quantity = quantityInput ? parseInt(quantityInput.value) : 1;
                        this.addToCart(target.dataset.id, quantity);
                    }
                }
            };
            
            app.init();
        });
    </script>
</body>
</html>