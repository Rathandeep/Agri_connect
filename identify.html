<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Plant Identification - AgriConnect</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

    <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
    
    <script type="importmap">
    {
        "imports": {
            "@google/genai": "https://esm.run/@google/genai"
        }
    }
    </script>

    <style>
        :root {
            --primary-color: #2ECC71; --primary-hover: #27ae60; --secondary-color: #16A085;
            --heading-color: #2c3e50; --text-color: #34495e; --light-text: #7f8c8d;
            --bg-color: #ffffff; --alt-bg-color: #f4f7f6; --border-color: #e0e0e0;
            --white-color: #ffffff; --danger-color: #e74c3c;
            --primary-gradient: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            --card-shadow: 0 4px 12px rgba(0, 0, 0, 0.06);
            --font-family: 'Inter', sans-serif; --transition-speed: 0.3s; --border-radius: 12px;
        }
        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
        html { scroll-behavior: smooth; }
        body { font-family: var(--font-family); color: var(--text-color); background-color: var(--alt-bg-color); line-height: 1.7; }
        .container { max-width: 1200px; margin: 0 auto; padding: 0 20px; }
        .app-section { padding: 80px 0; }
        .section-header { text-align: center; margin-bottom: 2rem; }
        .section-header h3 { font-size: 2.5rem; color: var(--heading-color); }
        .section-header p { font-size: 1.1rem; color: var(--light-text); max-width: 600px; margin: 0 auto; }
        .app-header { background-color: rgba(255, 255, 255, 0.8); backdrop-filter: blur(10px); padding: 1rem 0; border-bottom: 1px solid #e0e0e0; position: sticky; top: 0; z-index: 1000; }
        .app-header .container, .logo, .main-nav { display: flex; align-items: center; }
        .app-header .container { justify-content: space-between; }
        .logo { gap: 12px; text-decoration: none; }
        .logo h1 { font-size: 1.6rem; color: var(--heading-color); }
        .main-nav a { text-decoration: none; color: var(--text-color); font-weight: 600; }
        .card { background: var(--bg-color); border-radius: var(--border-radius); padding: 2rem; box-shadow: var(--card-shadow); }
        .btn { display: inline-block; padding: 12px 28px; border-radius: 50px; border: 2px solid transparent; font-size: 0.95rem; font-weight: 600; cursor: pointer; text-decoration: none; text-align: center; transition: all var(--transition-speed) ease; }
        .btn:disabled { background: #bdc3c7; cursor: not-allowed; transform: none; box-shadow: none; }
        .btn-primary { background-image: var(--primary-gradient); color: var(--white-color); border: none; }
        .btn-primary:not(:disabled):hover { transform: translateY(-4px); box-shadow: 0 8px 15px rgba(46, 204, 113, 0.3); }
        .btn-secondary { background-color: transparent; color: var(--text-color); border-color: var(--border-color); }
        .btn-secondary:hover { background-color: var(--alt-bg-color); }
        .identification-layout { display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; align-items: flex-start; }
        .upload-card, .result-card { height: 100%; }
        .image-drop-zone { border: 2px dashed var(--border-color); border-radius: var(--border-radius); padding: 2rem; text-align: center; cursor: pointer; transition: all var(--transition-speed); height: 350px; display: flex; align-items: center; justify-content: center; flex-direction: column; background-color: var(--alt-bg-color); }
        .image-drop-zone:hover, .image-drop-zone.dragover { border-color: var(--primary-color); background-color: #e8f5e9; }
        .image-drop-zone .upload-icon { color: var(--primary-color); margin-bottom: 1rem; }
        .upload-options { display: flex; gap: 1rem; justify-content: center; margin-top: 1.5rem; }
        #camera-view, #preview-view { display: none; }
        #camera-stream, #image-preview { width: 100%; height: 350px; object-fit: cover; border-radius: var(--border-radius); background: #eee; }
        .result-placeholder { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; text-align: center; color: var(--light-text); }
        .result-placeholder .icon { color: var(--primary-color); margin-bottom: 1rem; }
        .loader-container { display: none; flex-direction: column; align-items: center; justify-content: center; height: 100%; gap: 1rem; font-weight: 600; color: var(--heading-color); }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid var(--primary-color); border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .result-content h4 { font-size: 1.5rem; margin-bottom: 1rem; }
        .result-content h5 { font-size: 1.2rem; margin-top: 1.5rem; margin-bottom: 0.5rem; color: var(--secondary-color); }
        .result-content ul { list-style-position: inside; padding-left: 0; }
        .result-content li { margin-bottom: 0.5rem; }
        .scientific-name { font-style: italic; color: var(--light-text); font-size: 1.1rem; margin-top: -0.75rem; margin-bottom: 1rem; }
        @media (max-width: 900px) { .identification-layout { grid-template-columns: 1fr; } }
    </style>
</head>
<body>
    
    <header class="app-header">
       <div class="container">
            <a href="index.html" class="logo"><h1>AgriConnect</h1></a>
            <nav class="main-nav"><a href="#">AI Tools</a></nav>
        </div>
    </header>

    <main>
        <section class="app-section">
            <div class="container">
                <div class="section-header">
                    <h3>AI Plant Species Identification</h3>
                    <p>Discover the name and details of any plant. Upload a clear photo to get started.</p>
                </div>

                <div class="identification-layout">
                    <div class="card upload-card">
                        <div id="initial-upload-view">
                            <input type="file" id="plant-image-input" style="display: none;" accept="image/*">
                            <div id="image-drop-zone" class="image-drop-zone">
                                <div id="upload-prompt">
                                    <i data-feather="upload-cloud" class="upload-icon" style="width: 60px; height: 60px;"></i>
                                    <p style="font-size: 1.1rem; font-weight: 600;">Click to Upload or Drag & Drop</p>
                                    <span>PNG or JPG supported</span>
                                </div>
                            </div>
                            <div class="upload-options">
                                <label for="plant-image-input" class="btn btn-secondary">Choose File</label>
                                <button id="open-camera-btn" class="btn btn-secondary">Open Camera</button>
                            </div>
                        </div>

                        <div id="camera-view">
                            <video id="camera-stream" playsinline autoplay></video>
                            <button id="capture-btn" class="btn btn-primary" style="width: 100%; margin-top: 1rem;">Capture Photo</button>
                        </div>

                        <div id="preview-view">
                            <img id="image-preview" src="#" alt="Image Preview">
                            <div class="upload-options">
                                <button id="re-upload-btn" class="btn btn-secondary">Change Image</button>
                                <button id="identify-btn" class="btn btn-primary" disabled>Identify Plant</button>
                            </div>
                        </div>
                    </div>

                    <div class="card result-card">
                        <div id="result-placeholder" class="result-placeholder">
                            <i data-feather="search" class="icon" style="width: 60px; height: 60px;"></i>
                            <h4>Identification Report</h4>
                            <p>Your plant identification will appear here.</p>
                        </div>
                        <div id="loader-container" class="loader-container">
                            <div class="loader"></div>
                            <p>AI is identifying your plant... Please wait.</p>
                        </div>
                        <div id="result-content" style="display: none;">
                            </div>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <script type="module">
        import { GoogleGenAI } from "@google/genai";

        document.addEventListener('DOMContentLoaded', () => {
            feather.replace();
            const API_KEY = "AIzaSyCeil1RRuySImAxPOO6bxh31VDRXms4JSc";
            const ai = new GoogleGenAI({ apiKey: API_KEY });

            const identificationApp = {
                elements: {
                    initialView: document.getElementById('initial-upload-view'),
                    cameraView: document.getElementById('camera-view'),
                    previewView: document.getElementById('preview-view'),
                    imageInput: document.getElementById('plant-image-input'),
                    dropZone: document.getElementById('image-drop-zone'),
                    openCameraBtn: document.getElementById('open-camera-btn'),
                    cameraStream: document.getElementById('camera-stream'),
                    captureBtn: document.getElementById('capture-btn'),
                    imagePreview: document.getElementById('image-preview'),
                    reUploadBtn: document.getElementById('re-upload-btn'),
                    identifyBtn: document.getElementById('identify-btn'),
                    resultPlaceholder: document.getElementById('result-placeholder'),
                    loader: document.getElementById('loader-container'),
                    resultContent: document.getElementById('result-content'),
                },
                state: {
                    imageFile: null,
                    stream: null
                },

                init() {
                    this.bindEvents();
                },

                bindEvents() {
                    this.elements.dropZone.addEventListener('click', () => this.elements.imageInput.click());
                    this.elements.imageInput.addEventListener('change', this.handleFileSelect.bind(this));
                    this.elements.dropZone.addEventListener('dragover', e => { e.preventDefault(); this.elements.dropZone.classList.add('dragover'); });
                    this.elements.dropZone.addEventListener('dragleave', e => { e.preventDefault(); this.elements.dropZone.classList.remove('dragover'); });
                    this.elements.dropZone.addEventListener('drop', this.handleDrop.bind(this));
                    this.elements.openCameraBtn.addEventListener('click', this.startCamera.bind(this));
                    this.elements.captureBtn.addEventListener('click', this.capturePhoto.bind(this));
                    this.elements.reUploadBtn.addEventListener('click', this.reset.bind(this));
                    this.elements.identifyBtn.addEventListener('click', this.identifyImage.bind(this));
                },

                showView(viewToShow) {
                    ['initialView', 'cameraView', 'previewView'].forEach(view => {
                        this.elements[view].style.display = (view === viewToShow) ? 'block' : 'none';
                    });
                },

                handleFileSelect(event) {
                    const file = event.target.files[0];
                    if (file && file.type.startsWith('image/')) {
                        this.state.imageFile = file;
                        this.elements.imagePreview.src = URL.createObjectURL(file);
                        this.elements.identifyBtn.disabled = false;
                        this.showView('previewView');
                    }
                },

                handleDrop(event) {
                    event.preventDefault();
                    this.elements.dropZone.classList.remove('dragover');
                    const file = event.dataTransfer.files[0];
                    if (file && file.type.startsWith('image/')) {
                        this.elements.imageInput.files = event.dataTransfer.files;
                        this.elements.imageInput.dispatchEvent(new Event('change'));
                    }
                },
                
                async startCamera() {
                    try {
                        this.state.stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
                        this.elements.cameraStream.srcObject = this.state.stream;
                        this.showView('cameraView');
                    } catch (err) {
                        alert("Could not access the camera. Please ensure you have given permission.");
                    }
                },

                capturePhoto() {
                    const canvas = document.createElement('canvas');
                    canvas.width = this.elements.cameraStream.videoWidth;
                    canvas.height = this.elements.cameraStream.videoHeight;
                    canvas.getContext('2d').drawImage(this.elements.cameraStream, 0, 0);
                    canvas.toBlob(blob => {
                        this.state.imageFile = new File([blob], "capture.jpg", { type: "image/jpeg" });
                        this.elements.imagePreview.src = URL.createObjectURL(this.state.imageFile);
                        this.elements.identifyBtn.disabled = false;
                        this.showView('previewView');
                        this.stopCamera();
                    }, 'image/jpeg');
                },

                stopCamera() {
                    if (this.state.stream) {
                        this.state.stream.getTracks().forEach(track => track.stop());
                        this.state.stream = null;
                    }
                },

                reset() {
                    this.state.imageFile = null;
                    this.elements.imageInput.value = '';
                    this.elements.identifyBtn.disabled = true;
                    this.elements.resultContent.style.display = 'none';
                    this.elements.resultPlaceholder.style.display = 'flex';
                    this.showView('initialView');
                    this.stopCamera();
                },

                async identifyImage() {
                    if (!this.state.imageFile) return alert("Please select an image first.");
                    
                    this.elements.loader.style.display = 'flex';
                    this.elements.resultPlaceholder.style.display = 'none';
                    this.elements.resultContent.style.display = 'none';

                    try {
                        const model = 'gemini-2.5-flash';
                        const prompt = "You are a botanist. Identify the plant species in this image. Provide the common name, scientific name, a brief description, and a bulleted list of 3-4 key characteristics (like leaf shape, flower color, etc.). Structure your response exactly like this: COMMON_NAME: [Common Name] | SCIENTIFIC_NAME: [Scientific Name] | DESCRIPTION: [Brief one-sentence description.] | CHARACTERISTICS: [Bulleted list of characteristics]";
                        
                        const imagePart = await this.fileToGenerativePart(this.state.imageFile);
                        
                        const response = await ai.models.generateContent({
                           model: model,
                           contents: { parts: [{text: prompt}, imagePart] },
                        });
                        
                        const text = response.text;
                        
                        this.displayResult(text);

                    } catch (error) {
                        console.error("API Error:", error);
                        this.elements.resultContent.innerHTML = `<p style="color:var(--danger-color);"><strong>Analysis Failed!</strong><br>Could not identify the plant. Please try a clearer image or check your API key.</p>`;
                        this.elements.resultContent.style.display = 'block';
                    } finally {
                        this.elements.loader.style.display = 'none';
                    }
                },

                displayResult(text) {
                    const parts = text.split('|').reduce((acc, part) => {
                        const [key, ...value] = part.split(':');
                        if (key && value) acc[key.trim().toUpperCase()] = value.join(':').trim();
                        return acc;
                    }, {});

                    const characteristicsHtml = (parts.CHARACTERISTICS || 'No key characteristics available.')
                        .split('* ')
                        .filter(item => item.trim() !== '')
                        .map(item => `<li>${item.trim()}</li>`)
                        .join('');

                    this.elements.resultContent.innerHTML = `
                        <h4>${parts.COMMON_NAME || 'Unknown Plant'}</h4>
                        <p class="scientific-name">${parts.SCIENTIFIC_NAME || 'Scientific name not available'}</p>
                        <h5>Description:</h5>
                        <p>${parts.DESCRIPTION || 'No description available.'}</p>
                        <h5>Key Characteristics:</h5>
                        <ul>${characteristicsHtml}</ul>
                    `;
                    this.elements.resultContent.style.display = 'block';
                },

                async fileToGenerativePart(file) {
                    const base64EncodedDataPromise = new Promise((resolve) => {
                        const reader = new FileReader();
                        reader.onloadend = () => resolve(reader.result.split(',')[1]);
                        reader.readAsDataURL(file);
                    });
                    return { inlineData: { data: await base64EncodedDataPromise, mimeType: file.type } };
                }
            };

            identificationApp.init();
        });
    </script>
</body>
</html>